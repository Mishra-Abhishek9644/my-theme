{% comment %}
  This section is used in the product template to render product page with
  media, content, and add-to-cart form.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/product
{% endcomment %}

<section class="bg-white px-6 lg:px-16 py-16">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-16">
    <!-- LEFT: Product Images -->
    <div>
      <!-- Main Image -->
      <div class="overflow-hidden relative aspect-square rounded-md">
        <!-- ✅ Slider Track -->
        <div id="slider-track" class="flex transition-transform duration-300 ease-in-out">
          {% for image in product.images %}
            <img
              src="{{ image | image_url: width: 1200 }}"
              class="w-full flex-shrink-0 object-cover"
              height=""
              width=""
            >
          {% endfor %}
        </div>
      </div>

      <!-- Thumbnails -->
      {% if product.images.size > 1 %}
        <div class="mt-4 flex gap-3 justify-center items-center">
          {% for image in product.images %}
            <img
              src="{{ image | image_url: width: 200 }}"
              data-large="{{ image | image_url: width: 1200 }}"
              data-index="{{ forloop.index0 }}"
              alt="{{ product.title }}"
              class="w-20 h-20 object-cover rounded-md border cursor-pointer"
              height=""
              width=""
            >
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- RIGHT: Product Info -->
    <div class="flex flex-col gap-6">
      <p class="text-xl text-black">
        {{ product.price | money }}
      </p>
      <div class="flex items-center gap-4">
        <h1 class="text-3xl font-semibold text-black">
          {{ product.title }}
        </h1>

        {% if product.compare_at_price > product.price %}
          <p class="text-gray-400 line-through">
            {{ product.compare_at_price | money }}
          </p>
        {% endif %}
      </div>

      <!-- Short description -->
      {% if product.description != blank %}
        <div class="text-gray-700 leading-relaxed">
          {{ product.description }}
        </div>
      {% endif %}

      <!-- Product Form -->
      {% form 'product', product %}
        {% assign current_variant = product.selected_or_first_available_variant %}

        <!-- Variant selector -->
        {% if product.variants.size > 1 %}
          {% assign color_option_index = 0 %}

          {%- for option in product.options_with_values -%}
            {% if option.name == 'Color' or option.name == 'colour' %}
              {% assign color_option_index = forloop.index0 %}
            {% endif %}
          {%- endfor -%}

          <!-- ✅ Color Variant Swatches -->
          <div class="mt-4">
            <p class="font-medium mb-2">Choose Color:</p>

            <div class="flex gap-3">
              {% for value in product.options_with_values[color_option_index].values %}
                {% assign matched_variant = product.variants | where: 'option1', value | first %}

                <label class="cursor-pointer">
                  <!-- Hidden Radio -->
                  <input
                    type="radio"
                    name="id"
                    value="{{ matched_variant.id }}"
                    class="hidden peer variant-radio"
                    data-image="{{ matched_variant.featured_image | image_url: width: 1200 }}"
                    {% if matched_variant.id == current_variant.id %}
                      checked
                    {% endif %}
                  >

                  <!-- Circle Swatch -->
                  <div
                    class="w-10 h-10 rounded-full border peer-checked:ring-2 peer-checked:ring-black"
                    style="background-color: {{ value | downcase }};"
                    title="{{ value }}"
                  ></div>
                </label>
              {% endfor %}
            </div>
          </div>

        {% else %}
          <input type="hidden" name="id" value="{{ current_variant.id }}">
        {% endif %}

        <!-- Quantity -->
        <div class="flex items-center gap-4 mt-6">
          <!-- Quantity Selector -->
          <div class="flex items-center border rounded-md overflow-hidden">
            <button
              type="button"
              class="px-4 py-3 text-lg hover:bg-gray-100"
              onclick="this.nextElementSibling.stepDown()"
            >
              −
            </button>

            <input
              type="number"
              name="quantity"
              min="1"
              value="1"
              class="w-14 text-center outline-none"
            >

            <button
              type="button"
              class="px-4 py-3 text-lg hover:bg-gray-100"
              onclick="this.previousElementSibling.stepUp()"
            >
              +
            </button>
          </div>

          <!-- Add to Cart -->
          <button
            type="submit"
            class="flex-1 bg-white border border-1 text-black py-3.5 rounded-md hover:bg-black hover:text-white transition"
          >
            Add to cart
          </button>
        </div>
        <button
          type="button"
          class="wishlist-btn w-full bg-white border text-black py-3.5 my-2 rounded-md hover:bg-black hover:text-white transition"
          data-id="{{ product.id }}"
        >
          ❤️ Add to Wishlist
        </button>

        <!-- Dynamic checkout -->
        <div class="">
          {{ form | payment_button }}
        </div>
      {% endform %}
    </div>
  </div>
</section>

{% schema %}
{
  "name": "t:general.product",
  "settings": [],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const track = document.getElementById('slider-track');
    const slides = track.querySelectorAll('img');
    const thumbnails = document.querySelectorAll('[data-index]');
    const radios = document.querySelectorAll('.variant-radio');

    let currentIndex = 0;

    // ✅ Update Slide Position
    function updateSlide(index) {
      if (index < 0) index = 0;
      if (index >= slides.length) index = slides.length - 1;

      currentIndex = index;

      track.style.transition = 'transform 0.3s ease';
      track.style.transform = `translateX(-${currentIndex * 100}%)`;

      // ✅ Highlight active thumbnail
      thumbnails.forEach((t) => t.classList.remove('ring-2', 'ring-black'));
      if (thumbnails[index]) {
        thumbnails[index].classList.add('ring-2', 'ring-black');
      }
    }

    // ✅ Thumbnail Click
    thumbnails.forEach((thumb) => {
      thumb.addEventListener('click', () => {
        updateSlide(parseInt(thumb.dataset.index));
      });
    });

    // ✅ Color Swatch Click → Change Image
    radios.forEach((radio) => {
      radio.addEventListener('change', function () {
        const variantImage = this.dataset.image;
        if (!variantImage) return;

        slides.forEach((slide, index) => {
          // Match variant featured image
          if (slide.src.includes(variantImage.split('?')[0])) {
            updateSlide(index);
          }
        });
      });
    });

    // ✅ Swipe Support
    let startX = 0;
    let moveX = 0;
    let isDragging = false;

    track.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      isDragging = true;
      track.style.transition = 'none';
    });

    track.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      moveX = e.touches[0].clientX - startX;

      track.style.transform = `translateX(calc(-${currentIndex * 100}% + ${moveX}px))`;
    });

    track.addEventListener('touchend', () => {
      isDragging = false;

      if (moveX < -80) updateSlide(currentIndex + 1);
      else if (moveX > 80) updateSlide(currentIndex - 1);
      else updateSlide(currentIndex);

      moveX = 0;
    });

    const checkedRadio = document.querySelector('.variant-radio:checked');

    if (checkedRadio) {
      checkedRadio.dispatchEvent(new Event('change'));
    }
  });
</script>
